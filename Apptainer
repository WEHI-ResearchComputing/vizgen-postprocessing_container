BootStrap: docker
From: ubuntu:22.04

%post
    # Use bash as the default shell
    /bin/bash

    # Set environment variables
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1

    # Install system libraries
    apt-get update && \
    apt-get install -y \
        python3 \
        python3-pip \
        bzip2 \
        default-jre \
        curl \
        unzip \
        libgl1-mesa-glx \
        libvips42 \
        procps \
        git && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

    # Install Nextflow
    curl -fsSL get.nextflow.io | bash && \
    mv nextflow /usr/local/bin && \
    /usr/local/bin/nextflow self-update

    # Install aws cli
    curl https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip --output awscli-exe-linux-x86_64.zip && \
    unzip awscli-exe-linux-x86_64.zip && \
    ./aws/install && \
    rm awscli-exe-linux-x86_64.zip && \
    rm -rf /aws

    # Install VPT
    pip install --upgrade pip && \
    pip install vpt && \
    pip install vpt-plugin-cellpose2 && \
    rm -rf /root/.cache

%environment
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1

%runscript
    exec /bin/bash
